 {{
    config(
        materialized='incremental'
    )
}}


with stg as (
    SELECT
	CXKEY_MSRMNT_ID,
	TEST_COND_CNTXT_VAL_TYP,
	TEST_COND_CONTXT_NM,
	TEST_COND_CONTXT_ACT_VAL,
	TEST_COND_UNT,
	TEST_COND_IS_EXPT_IND,
	TEST_COND_OFFSET_VAL,
	TEST_COND_INDENT,
	TEST_COND_ALTCONTENT,
	COL2_CNTXT_VAL_TYP,
	COL2_CONTXT_NM,
	COL2_CONTXT_ACT_VAL,
	COL2_UNT,
	COL2_IS_EXPT_IND,
	COL2_OFFSET_VAL,
	COL2_INDENT,
	COL2_ALTCONTENT,
	COL3_CNTXT_VAL_TYP,
	COL3_CONTXT_NM,
	COL3_CONTXT_ACT_VAL,
	COL3_UNT,
	COL3_IS_EXPT_IND,
	COL3_OFFSET_VAL,
	COL3_INDENT,
	COL3_ALTCONTENT,
	COL4_CNTXT_VAL_TYP,
	COL4_CONTXT_NM,
	COL4_CONTXT_ACT_VAL,
	COL4_UNT,
	COL4_IS_EXPT_IND,
	COL4_OFFSET_VAL,
	COL4_INDENT,
	COL4_ALTCONTENT,
	COL5_CONTXT_NM,
	COL5_CNTXT_VAL_TYP,
	COL5_CONTXT_ACT_VAL,
	COL5_UNT,
	COL5_IS_EXPT_IND,
	COL5_OFFSET_VAL,
	COL5_INDENT,
	COL5_ALTCONTENT,
	COL6_CNTXT_VAL_TYP,
	COL6_CONTXT_NM,
	COL6_CONTXT_ACT_VAL,
	COL6_UNT,
	COL6_IS_EXPT_IND,
	COL6_OFFSET_VAL,
	COL6_INDENT,
	COL6_ALTCONTENT,
	COL7_CNTXT_VAL_TYP,
	COL7_CONTXT_NM,
	COL7_CONTXT_ACT_VAL,
	COL7_UNT,
	COL7_IS_EXPT_IND,
	COL7_OFFSET_VAL,
	COL7_INDENT,
	COL7_ALTCONTENT,
	COL8_CNTXT_VAL_TYP,
	COL8_CONTXT_NM,
	COL8_CONTXT_ACT_VAL,
	COL8_UNT,
	COL8_IS_EXPT_IND,
	COL8_OFFSET_VAL,
	COL8_INDENT,
	COL8_ALTCONTENT,
	COL9_CNTXT_VAL_TYP,
	COL9_CONTXT_NM,
	COL9_CONTXT_ACT_VAL,
	COL9_UNT,
	COL9_IS_EXPT_IND,
	COL9_OFFSET_VAL,
	COL9_INDENT,
	COL9_ALTCONTENT,
	COL10_CNTXT_VAL_TYP,
	COL10_CONTXT_NM,
	COL10_CONTXT_ACT_VAL,
	COL10_UNT,
	COL10_IS_EXPT_IND,
	COL10_OFFSET_VAL,
	COL10_INDENT,
	COL10_ALTCONTENT,
	MIN_CNTXT_VAL_TYP,
	MIN_CONTXT_NM,
	MIN_CONTXT_ACT_VAL,
	MIN_UNT,
	MIN_IS_EXPT_IND,
	MIN_OFFSET_VAL,
	MIN_INDENT,
	MIN_ALTCONTENT,
	MEASURED_CNTXT_VAL_TYP,
	MEASURED_CONTXT_NM,
	MEASURED_CONTXT_ACT_VAL,
	MEASURED_UNT,
	MEASURED_IS_EXPT_IND,
	MEASURED_OFFSET_VAL,
	MEASURED_INDENT,
	MEASURED_ALTCONTENT,
	MAX_CNTXT_VAL_TYP,
	MAX_CONTXT_NM,
	MAX_CONTXT_ACT_VAL,
	MAX_UNT,
	MAX_IS_EXPT_IND,
	MAX_OFFSET_VAL,
	MAX_INDENT,
	MAX_ALTCONTENT,
	APP_UNCRTNTY_CNTXT_VAL_TYP,
	APP_UNCRTNTY_CONTXT_NM,
	APP_UNCRTNTY_CONTXT_ACT_VAL,
	APP_UNCRTNTY_UNT,
	APP_UNCRTNTY_IS_EXPT_IND,
	APP_UNCRTNTY_OFFSET_VAL,
	APP_UNCRTNTY_INDENT,
	APP_UNCRTNTY_ALTCONTENT,
    CA_MSRMNT_RESLT_STG.CXKEY_SRVC_ORD_NUM, 
    CA_MSRMNT_RESLT_STG.LAST_MODIFIED_DT, 
    CA_MSRMNT_RESLT_STG.CXKEY_CAL_PROCEDURE_ID, 
    CA_MSRMNT_RESLT_STG.CXKEY_MFGR_ID, 
    CA_MSRMNT_RESLT_STG.CXKEY_MFGR_MDL_NUM, 
    CA_MSRMNT_RESLT_STG.CXKEY_SR_NUM, 
    CA_MSRMNT_RESLT_STG.CXKEY_FRMWRK_ID, 
    CA_MSRMNT_RESLT_STG.CXKEY_SUBMITTING_ENTITY, 
    CA_MSRMNT_RESLT_STG.CXKEY_CAL_TEST_RESLT_NM, 
    CA_MSRMNT_RESLT_STG.CXKEY_CAL_TEST_RESLT_TYP,
    CA_MSRMNT_RESLT_STG.CXKEY_APP_PLATFORM, 
    CA_MSRMNT_RESLT_STG.CXKEY_APP_ID, 
    CA_MSRMNT_RESLT_STG.CXKEY_TEST_DATA_SCTN_NM, 
    CA_MSRMNT_RESLT_STG.CXKEY_TEST_DATA_SCTN_UNIQUE_ID, 
    CA_MSRMNT_RESLT_STG.TEST_CONDITION, 
    CA_MSRMNT_RESLT_STG.CONDITION_2, 
    CA_MSRMNT_RESLT_STG.SHORT_DATA_ID,
    CA_MSRMNT_RESLT_STG.INSERT_DT,
    CA_MSRMNT_RESLT_STG.UPD_DT
    FROM
    {{ ref('ca_msrmnt_contxt_val_typ_stg') }} CA_MSRMNT_CONTXT_VAL_TYP_STG,{{ ref('ca_msrmnt_reslt_stg') }} CA_MSRMNT_RESLT_STG
    WHERE CA_MSRMNT_CONTXT_VAL_TYP_STG.CXKEY_MSRMNT_ID=CA_MSRMNT_RESLT_STG.MSRMNT_ID
    ),
  lkp as (
    select
    TGT.MSRMNT_RESLT_AND_DATA_ID,
    STG.CXKEY_MSRMNT_ID,
	TEST_COND_CNTXT_VAL_TYP,
	TEST_COND_CONTXT_NM,
	TEST_COND_CONTXT_ACT_VAL,
	TEST_COND_UNT,
	TEST_COND_IS_EXPT_IND,
	TEST_COND_OFFSET_VAL,
	TEST_COND_INDENT,
	TEST_COND_ALTCONTENT,
	COL2_CNTXT_VAL_TYP,
	COL2_CONTXT_NM,
	COL2_CONTXT_ACT_VAL,
	COL2_UNT,
	COL2_IS_EXPT_IND,
	COL2_OFFSET_VAL,
	COL2_INDENT,
	COL2_ALTCONTENT,
	COL3_CNTXT_VAL_TYP,
	COL3_CONTXT_NM,
	COL3_CONTXT_ACT_VAL,
	COL3_UNT,
	COL3_IS_EXPT_IND,
	COL3_OFFSET_VAL,
	COL3_INDENT,
	COL3_ALTCONTENT,
	COL4_CNTXT_VAL_TYP,
	COL4_CONTXT_NM,
	COL4_CONTXT_ACT_VAL,
	COL4_UNT,
	COL4_IS_EXPT_IND,
	COL4_OFFSET_VAL,
	COL4_INDENT,
	COL4_ALTCONTENT,
	COL5_CONTXT_NM,
	COL5_CNTXT_VAL_TYP,
	COL5_CONTXT_ACT_VAL,
	COL5_UNT,
	COL5_IS_EXPT_IND,
	COL5_OFFSET_VAL,
	COL5_INDENT,
	COL5_ALTCONTENT,
	COL6_CNTXT_VAL_TYP,
	COL6_CONTXT_NM,
	COL6_CONTXT_ACT_VAL,
	COL6_UNT,
	COL6_IS_EXPT_IND,
	COL6_OFFSET_VAL,
	COL6_INDENT,
	COL6_ALTCONTENT,
	COL7_CNTXT_VAL_TYP,
	COL7_CONTXT_NM,
	COL7_CONTXT_ACT_VAL,
	COL7_UNT,
	COL7_IS_EXPT_IND,
	COL7_OFFSET_VAL,
	COL7_INDENT,
	COL7_ALTCONTENT,
	COL8_CNTXT_VAL_TYP,
	COL8_CONTXT_NM,
	COL8_CONTXT_ACT_VAL,
	COL8_UNT,
	COL8_IS_EXPT_IND,
	COL8_OFFSET_VAL,
	COL8_INDENT,
	COL8_ALTCONTENT,
	COL9_CNTXT_VAL_TYP,
	COL9_CONTXT_NM,
	COL9_CONTXT_ACT_VAL,
	COL9_UNT,
	COL9_IS_EXPT_IND,
	COL9_OFFSET_VAL,
	COL9_INDENT,
	COL9_ALTCONTENT,
	COL10_CNTXT_VAL_TYP,
	COL10_CONTXT_NM,
	COL10_CONTXT_ACT_VAL,
	COL10_UNT,
	COL10_IS_EXPT_IND,
	COL10_OFFSET_VAL,
	COL10_INDENT,
	COL10_ALTCONTENT,
	MIN_CNTXT_VAL_TYP,
	MIN_CONTXT_NM,
	MIN_CONTXT_ACT_VAL,
	MIN_UNT,
	MIN_IS_EXPT_IND,
	MIN_OFFSET_VAL,
	MIN_INDENT,
	MIN_ALTCONTENT,
	MEASURED_CNTXT_VAL_TYP,
	MEASURED_CONTXT_NM,
	MEASURED_CONTXT_ACT_VAL,
	MEASURED_UNT,
	MEASURED_IS_EXPT_IND,
	MEASURED_OFFSET_VAL,
	MEASURED_INDENT,
	MEASURED_ALTCONTENT,
	MAX_CNTXT_VAL_TYP,
	MAX_CONTXT_NM,
	MAX_CONTXT_ACT_VAL,
	MAX_UNT,
	MAX_IS_EXPT_IND,
	MAX_OFFSET_VAL,
	MAX_INDENT,
	MAX_ALTCONTENT,
	APP_UNCRTNTY_CNTXT_VAL_TYP,
	APP_UNCRTNTY_CONTXT_NM,
	APP_UNCRTNTY_CONTXT_ACT_VAL,
	APP_UNCRTNTY_UNT,
	APP_UNCRTNTY_IS_EXPT_IND,
	APP_UNCRTNTY_OFFSET_VAL,
	APP_UNCRTNTY_INDENT,
	APP_UNCRTNTY_ALTCONTENT,
    STG.CXKEY_SRVC_ORD_NUM, 
    STG.LAST_MODIFIED_DT, 
    STG.CXKEY_CAL_PROCEDURE_ID, 
    STG.CXKEY_MFGR_ID, 
    STG.CXKEY_MFGR_MDL_NUM, 
    STG.CXKEY_SR_NUM, 
    STG.CXKEY_FRMWRK_ID, 
    STG.CXKEY_SUBMITTING_ENTITY, 
    STG.CXKEY_CAL_TEST_RESLT_NM, 
    STG.CXKEY_CAL_TEST_RESLT_TYP,
    STG.CXKEY_APP_PLATFORM, 
    STG.CXKEY_APP_ID, 
    STG.CXKEY_TEST_DATA_SCTN_NM, 
    STG.CXKEY_TEST_DATA_SCTN_UNIQUE_ID as CXKEY_TEST_DATA_SCTN_ID, 
    STG.TEST_CONDITION, 
    STG.CONDITION_2, 
    STG.SHORT_DATA_ID,
    STG.INSERT_DT,
    STG.UPD_DT
    from stg LEFT OUTER JOIN {{ ref('ca_msrmnt_reslt_and_data_fact') }} TGT ON
      STG.CXKEY_SRVC_ORD_NUM = TGT.CXKEY_SRVC_ORD_NUM AND
      STG.CXKEY_CAL_PROCEDURE_ID = TGT.CXKEY_CAL_PROCEDURE_ID AND
      STG.CXKEY_MFGR_ID = TGT.CXKEY_MFGR_ID AND
      STG.CXKEY_MFGR_MDL_NUM =  TGT.CXKEY_MFGR_MDL_NUM AND
      STG.CXKEY_SR_NUM = TGT.CXKEY_SR_NUM AND
      STG.CXKEY_FRMWRK_ID = TGT.CXKEY_FRMWRK_ID AND
      STG.CXKEY_SUBMITTING_ENTITY = TGT.CXKEY_SUBMITTING_ENTITY AND
    --   STG.CXKEY_APP_PLATFORM  = TGT.CXKEY_APP_PLATFORM AND
    --   STG.CXKEY_APP_ID  = TGT.CXKEY_APP_ID AND
      STG.CXKEY_CAL_TEST_RESLT_NM  = TGT.CXKEY_CAL_TEST_RESLT_NM AND
      STG.CXKEY_TEST_DATA_SCTN_NM  = TGT.CXKEY_TEST_DATA_SCTN_NM AND
      STG.CXKEY_CAL_TEST_RESLT_TYP  = TGT.CXKEY_CAL_TEST_RESLT_TYP AND
      STG.LAST_MODIFIED_DT = TGT.LAST_MODIFIED_DT AND
      STG.TEST_CONDITION = TGT.MSRMNT_DATA_TEST_COND AND
      STG.CONDITION_2 = TGT.MSRMNT_DATA_COND_2 AND
      STG.SHORT_DATA_ID = TGT.MSRMNT_DATA_SHORT_DATA_ID
  ) SELECT distinct CA_MSRMNT_CONTXT_VAL_TYP_SEQ.nextval as CXKEY_CONTXT_VAL_TYP_ID, * FROM LKP where MSRMNT_RESLT_AND_DATA_ID IS NOT NULL AND CXKEY_MSRMNT_ID IS NOT NULL
  
  